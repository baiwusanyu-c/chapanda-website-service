# chapanda-website-service 部署步骤

核心思路：
* 在 `CI/CD` 中编写脚本和设置环境变量，`workflow` 被触发时，连接服务器来拉取最新代码
* 拉取最新代码后，安装代码依赖并打包，然后将产物和必要文件复制到 `docker` 容器中（依赖 `Dockerfile`）
* 代码仓库中应该包含 `Dockerfile`、`docker-compose`、`.dockerignore`、`setup.sh`
* 在打包完成后，执行 `setup.sh`,它将启动 `docker-compose`，而 `docker-compose` 中则会启动镜像（`nest`、`mysql`、`redis` 等）
`Dockerfile` 则会从宿主主机复制项目代码到容器中进行启动



## 服务器初始化
直接使用宝塔镜像安装到服务器上，可以使用宝塔页面进行各种安装，同时一些基础安装指令和配置这里不再赘述，
仅给出需要哪些初始化环境，以及要这些环境来做什么。

### 服务器安装 git
在我们的服务器中，需要从目标仓库拉取源码，因此需要 `git`；
在安装好 `git` 后，可以配置 `ssh` 或 `token` 的方式给 `git` 进行授权，以便 `git` 有权限能够
拉取目标仓库代码。
本文是拉取的 `github` 代码，使用 `github token` 进行授权，它将通过 `github` 的 `workflow` 作为环境变量传递进来，
在拉取代码时设置，最终实现代码拉取

### 服务器安装 pnpm & node
我们的后端和前端项目在拉取完代码后，需要进行打包构建，然后将构建产物复制到 `docker` 容器汇总，
因此需要安装 `nodejs` 和 `pnpm` 以便能够进行打包，
具体的包管理器根据项目而定，也可以时 `npm` 或 `yarn`；
ps：另外的思路是直接在 `docker` 容器中进行构建，那么这一步就可以省略

### 服务器安装 docker
宝塔页面安装 `docker`，他将用于运行容器，里面跑我们的各种环境（`redis`、`mysql`、`nest`、`next`、`nginx`、`minio`）

### 配置 ssh 密钥对访问
详情参考阿里云文档
大致的步骤分为
* 使用终端命令或在阿里云控制台生成 `ssh` 密钥对
* 使用终端命令或工具对密钥对进行解析获取公钥
* 在服务器中设置公钥
* 在服务区中开启 `ssh` 配置

## 后端项目脚本编写
## TODO 编写 CI/CD 脚本（以 github 为例）
在项目根目录下创建 `.github/workflow/deploy.yml`

## 编写 .dockerignore

在执行 `Docker` 操作时，忽略的文件内容，在 `nest` 项目中，我们构建之后只会构建业务代码，
并不会讲依赖进行打包，本文的思路是在宿主容器中打包，将产物和其他必要代码复制到 `docker` 容器内，
此时设置 `.dockerignore` 来忽略内容，尤其是 `node_modules`
我们的 `Dockerfile` 会从容器外复制项目源码和到容器内，

```dockerignore
node_modules/
.vscode/
.git/
```

## 编写 setup.sh
在 `CI/CD `中，我们链接了部署服务器，并拉取了代码，
此时我们需要一个脚本来启动 `docker`，我们使用 `docker-compose` 来启动多个容器，
其中包括 `next` 前端、`nest` 后端、`oss` 文件存储的 `minio`、`redis` 数据库、`mysql` 数据库、`nginx` 等，
这个脚本我们把它命名为 `setup.sh`,并存放在后端项目 `scripts` 中
```shell
#!/usr/bin/env bash
#image_version=`date +%Y%m%d%H%M`;
# 关闭容器
docker-compose stop || true;
# 删除容器
docker-compose down || true;
# 构建镜像
docker-compose build;
# 启动并后台运行
docker-compose up -d;
# 查看日志
docker logs chapanda-website-service;
# 对空间进行自动清理
docker system prune -a -f
```
## 编写 Docker-Compose
## 编写 Dockerfile
