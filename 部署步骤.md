# chapanda-website-service 部署详解
## 前置工作
* 有一台自己的服务器
* 有一个自己的域名,一定要备案通过，否则https请求不通
* 为域名申请一个 `SSL` 证书

## 部署核心思路
1. 在 `CI/CD` 中编写脚本和设置环境变量，`workflow` 被触发时，通过 `ssh` 连接服务器来拉取最新代码
2. 服务器拉取最新代码后，安装代码依赖并打包，然后将产物和必要文件复制到 `docker` 容器中（依赖 `Dockerfile`）
3. 代码仓库中应该包含 `Dockerfile`、`docker-compose.yml`、`.dockerignore`、`setup.sh`
4. 在打包完成后，执行 `setup.sh`,它将启动 `docker-compose`，而 `docker-compose` 中则会启动容器,
`Dockerfile` 则会从宿主主机复制项目代码到容器中进行启动

> 在思路 2 中，其实打包构建的过程也可以放到 `Dockerfile` 中执行

其中关于四个脚本文件的作用：
* `docker-compose.yml`用于启动多个容器，包括必要的环境容器，如 `mysql`、`redis`、`minio`、`nginx`，以及运行 `nest` 后端服务的 `Dockerfile`
* `setup.sh`用于启动和管理`docker-compose.yml`
* `Dockerfile`用于启动 `nest` 服务, 它会从宿主主机复制代码文件到容器内然后运行服务
* `.dockerignore` 是`Dockerfile`复制文件时的忽略文件设置，比如 `node_modules` 就需要忽略

## 服务器初始化
根据需求选择合适的环境运行方式，笔者直接使用的宝塔镜像，会方便很多，一些基础安装指令和配置这里不再赘述，
仅给出需要哪些初始化环境，以及要这些环境来做什么。

### 服务器安装 git
在我们的服务器中，需要从目标仓库拉取源码，因此需要 `git`；
在安装好 `git` 后，可以配置 `ssh` 或 `token` 的方式给 `git` 进行授权，以便 `git` 有权限能够
拉取目标仓库代码。
本文是拉取的 `github` 代码，使用 `github token` 进行授权，它将通过 `github` 的 `workflow` 作为环境变量传递进来，
在拉取代码时设置，最终实现代码拉取

### 配置 ssh 密钥对访问
详情参考阿里云文档
大致的步骤分为
* 使用终端命令或在阿里云控制台生成 `ssh` 密钥对
* 使用终端命令或工具对密钥对进行解析获取公钥
* 在服务器中设置公钥
* 在服务区中开启 `ssh` 配置

### 服务器安装 pnpm & node
我们的后端和前端项目在拉取完代码后，需要进行打包构建，然后将构建产物复制到 `docker` 容器汇总，
因此需要安装 `nodejs` 和 `pnpm` 以便能够进行打包，
具体的包管理器根据项目而定，也可以时 `npm` 或 `yarn`；
>另外的思路是直接在 `docker` 容器中进行构建，那么这一步就可以省略

### 服务器安装 docker
宝塔页面安装 `docker`，他将用于运行容器，里面跑我们的各种环境（`redis`、`mysql`、`nest`、`next`、`nginx`、`minio`）

### 安装 rsync

### 创建必要的文件夹
选择合适的路径创建文件夹、文件，它们将用于 `docker` 挂载，以下是我使用的
文件夹路径，它们与 `docker-compose` 卷挂载路径相对应。
我在 `root` 用户目录下创建了 `chapanda` 文件夹用于存放文件

```text
chapand/
├── service/
│   └── chapanda-website-service/  # 用于打包和克隆后端项目
├── front/
│   └── chapanda-website/  # 用于打包和克隆前端项目
└── docker-volume/
    ├── chapanda-mysql/  # docker挂载mysql的卷
    ├── chapanda-minio/  # docker挂载minio的卷
    ├── chapanda-redis/  # docker挂载redis的卷
    └── chapanda-nginx/  # docker挂载nginx相关文件
        ├── logs/  # docker挂载nginx的日志
        ├── pid/  # docker挂载nginx的pid日志文件
        ├── cert/  # docker挂载nginx的证书
        └── nginx.conf  # docker挂载nginx配置文件
```

## 项目脚本编写

### 编写 CI/CD 脚本（以 github 为例）
在项目根目录下创建 `.github/workflow/deploy.yml`

```yaml
name: Deploy to Aliyun

# 仅在推送到 main 分支时触发
on:
  push:
    branches:
      - master  # 当推送到 main 分支时触发 workflow
  workflow_dispatch: # 允许手动触发，并可以指定分支
    inputs:
      branch:
        description: 'Branch to release from'
        required: true
        default: 'master'  # 默认使用 master 分支
        type: string
# 设置执行的工作
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to server
        # 设置各种环境变量，具体含义在文章最后给出
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_ROOT_USER: ${{ secrets.MYSQL_ROOT_USER }}
          MYSQL_SERVER_HOST: ${{ secrets.MYSQL_SERVER_HOST }}
          REDIS_SERVER_HOST: ${{ secrets.REDIS_SERVER_HOST }}
          REDIS_ROOT_PASSWORD: ${{ secrets.REDIS_ROOT_PASSWORD }}
          MINIO_SERVER_HOST: ${{ secrets.MINIO_SERVER_HOST }}
          MINIO_SERVER_BUKET: ${{ secrets.MINIO_SERVER_BUKET }}
          MINIO_SERVER_ACCESS: ${{ secrets.MINIO_SERVER_ACCESS }}
          MINIO_SERVER_SECRET: ${{ secrets.MINIO_SERVER_SECRET }}
          MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
          # run 指令执行脚本
          # 强制创建 .ssh 目录（-p 防止目录不存在报错）
          # 将私钥内容写入文件
          # 必须操作！SSH 协议要求私钥不可被其他用户读取,600 = 用户读写，其他无权限
          # 自动记录服务器指纹到信任列表,避免首次连接时的 "Are you sure?" 提示阻断流程
          # 通过 SSH 连接服务器,
          # 进入项目目录，这里我选择的是 ~/chapanda/service
          # 清空当前目录后，拉取最新代码待 chapanda-website-service目录，
          # 在 chapanda-website-service 目录内对后端项目并、安装依赖、打包
          # 写入必要的环境变量文件到 dist/env/.env 文件，后端项目会读取这个文件内容，作为环境变量使用
          # 如 export MYSQL_ROOT_PASSWORD='$MYSQL_ROOT_PASSWORD' 这几段是暴露设置一些必要的环境变量，他们会在 docker-compose 中使用
          # 执行 setup.sh，在当前目录启动 docker-compose
        run: |
            mkdir -p ~/.ssh
            echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
            ssh $SSH_USER@$SSH_HOST "
            cd ~/chapanda/service
            rm -rf ./chapanda-website-service || true
            git clone  "https://x-access-token:$GH_TOKEN@github.com/baiwusanyu-c/chapanda-website-service.git"
            cd ./chapanda-website-service 
            pnpm install
            pnpm run build
            mkdir -p ./chapanda-website-service/dist/env
            echo 'MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD' >> ./chapanda-website-service/dist/env/.env
            echo 'MYSQL_ROOT_USER=$MYSQL_ROOT_USER' >> ./chapanda-website-service/dist/env/.env
            echo 'MYSQL_SERVER_HOST=$MYSQL_SERVER_HOST' >> ./chapanda-website-service/dist/env/.env
            echo 'REDIS_SERVER_HOST=$REDIS_SERVER_HOST' >> ./chapanda-website-service/dist/env/.env
            echo 'REDIS_ROOT_PASSWORD=$REDIS_ROOT_PASSWORD' >> ./chapanda-website-service/dist/env/.env
            echo 'MINIO_SERVER_HOST=$MINIO_SERVER_HOST' >> ./chapanda-website-service/dist/env/.env
            echo 'MINIO_SERVER_ACCESS=$MINIO_SERVER_ACCESS' >> ./chapanda-website-service/dist/env/.env
            echo 'MINIO_SERVER_SECRET=$MINIO_SERVER_SECRET' >> ./chapanda-website-service/dist/env/.env
            echo 'MINIO_SERVER_BUKET=$MINIO_SERVER_BUKET' >> ./chapanda-website-service/dist/env/.env
            if [ ! -f ./chapanda-website-service/dist/env/.env ]; then
              echo '::error::.env 文件未生成'
              exit 1
            fi
            export MYSQL_ROOT_PASSWORD='$MYSQL_ROOT_PASSWORD'
            export REDIS_ROOT_PASSWORD='$REDIS_ROOT_PASSWORD'
            export MINIO_ROOT_USER='$MINIO_ROOT_USER'
            export MINIO_ROOT_PASSWORD='$MINIO_ROOT_PASSWORD'
            bash ./scripts/setup.sh"


```

### 编写 .dockerignore

在执行 `Docker` 操作时，忽略的文件内容，在 `nest` 项目中，我们构建之后只会构建业务代码，
并不会讲依赖进行打包，本文的思路是在宿主容器中打包，将产物和其他必要代码复制到 `docker` 容器内，
此时设置 `.dockerignore` 来忽略内容，尤其是 `node_modules`
我们的 `Dockerfile` 会从容器外复制项目源码和到容器内，

```dockerignore
node_modules/
.vscode/
.git/
```

### 编写 setup.sh
在 `CI/CD `中，我们链接了部署服务器，并拉取了代码，
此时我们需要一个脚本来启动 `docker`，我们使用 `docker-compose` 来启动多个容器，
其中包括 `next` 前端、`nest` 后端、`oss` 文件存储的 `minio`、`redis` 数据库、`mysql` 数据库、`nginx` 等，
这个脚本我们把它命名为 `setup.sh`,并存放在后端项目 `scripts` 中.
```shell
#!/usr/bin/env bash
#image_version=`date +%Y%m%d%H%M`;
# 关闭容器
docker-compose stop || true;
# 删除容器
docker-compose down || true;
# 构建镜像
docker-compose build;
# 启动并后台运行
docker-compose up -d;
# 查看日志
docker logs chapanda-website-service;
# 对空间进行自动清理
docker system prune -a -f
```

### TODO: 编写 docker-compose.yml
minio 如果是社区版 要使用 minio 的指令来生成 secret 和 access key

### 编写 Dockerfile

```dockerfile
FROM docker.1ms.run/library/node:23.0-alpine3.19 as copy-stage
# 设置工作目录
WORKDIR /chapanda-website-service
# 从 Dockerfile 所在的目录复制文件到容器的工作目录内
# 这里是将 .github/workflow/deploy.yml 执行的过程中拉取的后端项目源码和打包产物
# 复制到容器的工作目录内
COPY . .

# production stage
FROM docker.1ms.run/library/node:23.0-alpine3.19 as production-stage
# 从 copy-stage 步骤复制文件到当前步骤的指定工作目录内
# 复制打包产物
COPY --from=copy-stage /chapanda-website-service/dist /chapanda-website-service
# 复制 package.json
COPY --from=copy-stage /chapanda-website-service/package.json /chapanda-website-service/package.json
# 复制 i18n 文件夹内的语言配置，因为它不会被打包进 dist， 所以要手动复制
# 这里要注意要保证路径正确，不然 dist 的代码访问不带 i18n 的语言 json 文件
COPY --from=copy-stage /chapanda-website-service/i18n /chapanda-website-service/i18n
# 设置工作目录
WORKDIR /chapanda-website-service
# 设置 node 源地址
RUN npm config set registry https://registry.npmmirror.com/
# 安装 pnpm
RUN npm install pnpm --global
# 安装依赖， nestjs 打包不会将依赖打入构建产物，
# 所以需要安装依赖，才能够运行服务
RUN pnpm install
# 暴露后端服务端口，这里需要和后端项目所使用的端口一直
EXPOSE 8084
# 执行命令，运行后端服务
CMD ["node", "/chapanda-website-service/src/main.js"]

```

## TODO: 配置 nginx

## 配置 minio 的 Access key 和 Secret
minio 如果是社区版 要使用 minio 的指令来生成 secret 和 access key
https://min.io/docs/minio/linux/reference/minio-mc-admin/mc-admin-accesskey.html
## TODO: CI/CD 环境变量配置
## TODO: 数据库初始化迁移
